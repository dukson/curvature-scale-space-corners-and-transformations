<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ErosionFilter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jacoco Report</a> &gt; <a href="index.html" class="el_package">algorithms.imageProcessing</a> &gt; <span class="el_source">ErosionFilter.java</span></div><h1>ErosionFilter.java</h1><pre class="source lang-java linenums">package algorithms.imageProcessing;

import java.util.logging.Logger;

/**
 * The erosion filter iterates over all pixels in the image, checking whether
 * the current non-null pixel can be nulled without disconnecting any adjacent
 * pixels. 
 * 
 * TODO: the erosion filter doesn't know the overall shape so corners and lines
 * could be improved in the final result by adding templates to the filter
 * to find and handle potential lines and corners in a non-resolution dependent 
 * way.
 * 
 * TODO: It's all boolean rules, so it looks like a clever way of using boolean 
 * logic on more than 1 pixel as the current being tested for nullability,
 * at the same time should reduce common comparisons and make a faster filter.
 * 
 * @author nichole
 */
<span class="fc" id="L21">public class ErosionFilter extends AbstractLineThinner {</span>
    
<span class="fc" id="L23">    protected boolean useLineDrawingMode = false;</span>
    
<span class="fc" id="L25">    protected boolean debug = false;</span>
    
<span class="fc" id="L27">    private Logger log = Logger.getLogger(this.getClass().getName());</span>
    
    /**
     * for images which are already line drawings, that is images such as
     * maps with only lines, or for block images, use this to avoid a gap filling
     * stage that fills single pixel gaps surrounded by non-zero pixels.  
     * (Else, the filter applies such a gap filling algorithm to help avoid 
     * creating bubbles in thick lines).
     */
    @Override
    public void useLineDrawingMode() {
<span class="nc" id="L38">        useLineDrawingMode = true;</span>
<span class="nc" id="L39">    }</span>

    @Override
    public void setDebug(boolean setToDebug) {
<span class="nc" id="L43">        debug = setToDebug;</span>
<span class="nc" id="L44">    }</span>
    
    @Override
    public void applyFilter(final GreyscaleImage input) {
        
<span class="fc" id="L49">        GreyscaleImage output = input.copyImage();</span>
        
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">        if (!useLineDrawingMode) {</span>
<span class="fc" id="L52">            prefillGapsSurroundedByNeighbors(output);</span>
        }
        
<span class="fc" id="L55">        int count = 1;</span>
        
<span class="fc" id="L57">        int maxIter = 100;</span>
<span class="fc" id="L58">        int nIter = 0;</span>
        
        GreyscaleImage input2;
        
<span class="pc bpc" id="L62" title="1 of 4 branches missed.">        while ((count &gt; 0) &amp;&amp; (nIter &lt; maxIter)) {</span>
            
<span class="fc" id="L64">            count = 0;</span>
            
<span class="fc" id="L66">            input2 = output.copyImage();</span>
            
            // alternate the directions of approach to 'erode' from both 'sides'
<span class="fc bfc" id="L69" title="All 2 branches covered.">            if ((nIter &amp; 1) == 0) {</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">                for (int i = 0; i &lt; input2.getWidth(); i++) {</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">                    for (int j = 0; j &lt; input2.getHeight(); j++) {</span>
<span class="fc" id="L72">                        boolean nulled = process(input2, output, i, j);</span>
<span class="fc bfc" id="L73" title="All 2 branches covered.">                        if (nulled) {</span>
<span class="fc" id="L74">                            count++;</span>
                        }
                    }
                }
            } else {
<span class="fc bfc" id="L79" title="All 2 branches covered.">                for (int i = (input2.getWidth() - 1); i &gt; -1; i--) {</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">                    for (int j = (input2.getHeight() - 1); j &gt; -1; j--) {</span>
<span class="fc" id="L81">                        boolean nulled = process(input2, output, i, j);</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">                        if (nulled) {</span>
<span class="fc" id="L83">                            count++;</span>
                        }
                    }
                }
            }                                    
            
<span class="fc" id="L89">            log.fine(&quot;nulled &quot; + count + &quot; pixels&quot;);</span>
            
<span class="fc" id="L91">            nIter++;</span>
        }
        
<span class="fc" id="L94">        input.resetTo(output);</span>
<span class="fc" id="L95">    }</span>

    /**
     * instead of dilation, just fill in any gaps that have 4 neighbors already
     * filled in.  This should not act upon many pixels.
     * 
     * @param input
     */
    protected void prefillGapsSurroundedByNeighbors(final GreyscaleImage input) {
        
<span class="fc" id="L105">        int count = 1;</span>
               
<span class="fc bfc" id="L107" title="All 2 branches covered.">        for (int i = 0; i &lt; input.getWidth(); i++) {</span>

<span class="fc bfc" id="L109" title="All 2 branches covered.">            for (int j = 0; j &lt; input.getHeight(); j++) {</span>

<span class="fc bfc" id="L111" title="All 2 branches covered.">                if (input.getValue(i, j) &gt; 0) {</span>
<span class="fc" id="L112">                    continue;</span>
                }
                       
<span class="fc bfc" id="L115" title="All 4 branches covered.">                if (!isASmallerSearchRegion(input, i, j) &amp;&amp;</span>
                    hasImmediateFourNeighbors(input, i, j)) {
                      
<span class="fc" id="L118">                    float avg = input.getValue(i, j + 1) + input.getValue(i + 1, j)</span>
                        + input.getValue(i, j - 1) + input.getValue(i - 1, j);
                    
<span class="fc" id="L121">                    avg /= 4.f;</span>
                    
<span class="fc" id="L123">                    input.setValue(i, j, (int)avg);</span>
                    
<span class="fc" id="L125">                    count++;</span>
                }
            }
        }

<span class="fc" id="L130">        log.fine(&quot;filled in  &quot; + count + &quot; pixels&quot;);</span>
<span class="fc" id="L131">    }</span>

    /**
     * within the surrounding 8 pixels, return false if the point is the 
     * endpoint of a line with width of 1 pixel, or
     * return true if nulling the center point
     * would not disconnect the othe points or return true if the point.
     * 
     * TODO: compute the runtime complexity of this.
     * 
     * @param input
     * @param row
     * @param col
     * @return 
     */
    private boolean canBeNulled(final GreyscaleImage input, int col, int row) {
        
        /*
        handle edge cases, that is searches constrained to regions smaller than
        the full 3x3 neighborhood region, that is regions of sizes
           2X2 or 2x3 or 3X2
        */
       
<span class="fc" id="L154">        boolean isASmallerSearchRegion = isASmallerSearchRegion(</span>
            input, col, row);
        
<span class="fc bfc" id="L157" title="All 2 branches covered.">        if (isASmallerSearchRegion) {</span>
            
<span class="fc" id="L159">            boolean doesDisconnect = isASmallerSearchRegionAndDoesDisconnect(</span>
                input, col, row);

<span class="fc bfc" id="L162" title="All 2 branches covered.">            return !doesDisconnect;</span>
        }
        
        /*
        check that this isn't the endpoint of a 1 pixel width line.
        */
<span class="fc bfc" id="L168" title="All 2 branches covered.">        if (isTheEndOfAOnePixelLine(input, col, row)) {</span>
<span class="fc" id="L169">            return false;</span>
        }
        
        /*
        else, try the 8 pixel neighborhood with C being the current (col, row)
        and @ being the pixel tested for disconnection by setting C to 0. 
       
        . is a 0
        ? is an AND between possible '1's.  (&quot;At Least One&quot;)
        _ is a pixel that can be ignored

             (1)       (2)     (3)     (4)     (5)     (6)     (7)     (8)
             @ . ?    _ @ _   ? . @   ? . _   ? ? ?   ? ? ?   ? ? ?   _ . ?
             . C ?    . C .   ? C .   ? C @   ? C .   . C .   . C ?   @ C ?
             ? ? ?    ? ? ?   ? ? ?   ? . _   ? . @   _ @ _   @ . ?   _ . ?
        */

<span class="fc" id="L186">        boolean doesDisconnect = doesDisconnect(input, col, row);</span>
        
<span class="fc bfc" id="L188" title="All 2 branches covered.">        return !doesDisconnect;</span>
       
    }
    
    /**
     * this assumes that the invoker has checked that (col, row) has 1 pixel
     * to each side and 1 above and below.
     * @param input
     * @param col
     * @param row
     * @return 
     */
    protected boolean hasImmediateFourNeighbors(final GreyscaleImage input, 
        int col, int row) {
        
        /*   @
           @ C @
             @
        */
<span class="fc bfc" id="L207" title="All 8 branches covered.">        if ((input.getValue(col, row + 1) &gt; 0) &amp;&amp;</span>
            (input.getValue(col + 1, row) &gt; 0) &amp;&amp;
            (input.getValue(col, row - 1) &gt; 0) &amp;&amp;
            (input.getValue(col - 1, row) &gt; 0)) {
<span class="fc" id="L211">            return true;</span>
        }
        
<span class="fc" id="L214">        return false;</span>
    }
  
    /**
     * for the full 8 neighbor region, determine whether nulling the pixel
     * at (col, row) would disconnect the remaining line.  Note that the
     * boolean logic is embedded in the comments.  One should be able to
     * combine the rules for multiple pixel tests to reduce the redundant
     * comparisons for the regions in common.
     * 
     * @param input
     * @param col
     * @param row
     * @return 
     */
    protected boolean doesDisconnect(final GreyscaleImage input, int col, 
        int row) {
        
        /*
            6   7  8 
           11 *C* 12
           15  16 17
        */
                
        //6  Ʌ  8  Ʌ  ¬((7)  V  (11  Ʌ  16  Ʌ  12))
<span class="fc bfc" id="L239" title="All 12 branches covered.">        if (</span>
            ((input.getValue(col - 1, row + 1) &gt; 0) 
            &amp;&amp; (input.getValue(col + 1, row + 1) &gt; 0)) &amp;&amp; 
            !((input.getValue(col, row + 1) &gt; 0) 
            || 
            ((input.getValue(col - 1, row) &gt; 0)
            &amp;&amp; (input.getValue(col, row - 1) &gt; 0) 
            &amp;&amp; (input.getValue(col + 1, row) &gt; 0)))) {
<span class="fc" id="L247">            return true;</span>
        } else 
            //6  Ʌ  12  Ʌ  ¬((7)  V  (11  Ʌ  16))
<span class="fc bfc" id="L250" title="All 10 branches covered.">            if (</span>
            ((input.getValue(col - 1, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col + 1, row) &gt; 0)) &amp;&amp; 
                !((input.getValue(col, row + 1) &gt; 0)
                || 
                ((input.getValue(col - 1, row) &gt; 0) 
                &amp;&amp; (input.getValue(col, row - 1) &gt; 0)))) {
<span class="fc" id="L257">            return true;</span>
        } else 
            //6  Ʌ  17  Ʌ  ¬((7  Ʌ  12) V (11  Ʌ  16))
<span class="fc bfc" id="L260" title="All 12 branches covered.">            if (</span>
            ((input.getValue(col - 1, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col + 1, row - 1) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col, row + 1) &gt; 0)
                &amp;&amp; (input.getValue(col + 1, row) &gt; 0)) 
                || ((input.getValue(col - 1, row) &gt; 0) 
                &amp;&amp; (input.getValue(col, row - 1) &gt; 0)))) {
<span class="fc" id="L267">            return true;</span>
        } else 
            //6  Ʌ  16  Ʌ  ¬((7  Ʌ  12) V (11))
<span class="fc bfc" id="L270" title="All 10 branches covered.">            if (</span>
            ((input.getValue(col - 1, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col, row - 1) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col, row + 1) &gt; 0)
                &amp;&amp; (input.getValue(col + 1, row) &gt; 0)) 
                || (input.getValue(col - 1, row) &gt; 0))) {
<span class="fc" id="L276">            return true;</span>
        } else 
            //6  Ʌ  15  Ʌ  ¬((7  Ʌ  12 Ʌ 16) V (11))
<span class="fc bfc" id="L279" title="All 12 branches covered.">            if (</span>
            ((input.getValue(col - 1, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row - 1) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col + 1, row) &gt; 0) 
                &amp;&amp; (input.getValue(col, row - 1) &gt; 0)) 
                || (input.getValue(col - 1, row) &gt; 0))) {
<span class="fc" id="L286">            return true;</span>
        } else 
            //7  Ʌ  17  Ʌ  ¬((12)  V  (11  Ʌ  16))
<span class="fc bfc" id="L289" title="All 10 branches covered.">            if (</span>
            ((input.getValue(col, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col + 1, row - 1) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col - 1, row) &gt; 0)
                &amp;&amp; (input.getValue(col, row - 1) &gt; 0)) 
                || (input.getValue(col + 1, row) &gt; 0))) {
<span class="fc" id="L295">            return true;</span>
        } else 
            //7  Ʌ  16  Ʌ  ¬(12  V  11)
<span class="fc bfc" id="L298" title="All 8 branches covered.">            if (</span>
            ((input.getValue(col, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col, row - 1) &gt; 0)) &amp;&amp; 
                !((input.getValue(col + 1, row) &gt; 0)
                || (input.getValue(col - 1, row) &gt; 0))) {
<span class="fc" id="L303">            return true;</span>
        } else 
            //7  Ʌ  15  Ʌ  ¬((11)  V  (12 Ʌ 16))
<span class="fc bfc" id="L306" title="All 10 branches covered.">            if (</span>
            ((input.getValue(col, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row - 1) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col + 1, row) &gt; 0) 
                &amp;&amp; (input.getValue(col, row - 1) &gt; 0)) 
                || (input.getValue(col - 1, row) &gt; 0))) {
<span class="fc" id="L312">            return true;</span>
        } else 
            //8  Ʌ  17  Ʌ  ¬((12)  V  (7 Ʌ 11  Ʌ  16))
<span class="fc bfc" id="L315" title="All 12 branches covered.">            if (</span>
            ((input.getValue(col + 1, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col + 1, row - 1) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row) &gt; 0) 
                &amp;&amp; (input.getValue(col, row - 1) &gt; 0)) 
                || (input.getValue(col + 1, row) &gt; 0))) {
<span class="fc" id="L322">            return true;</span>
        } else 
            //8  Ʌ  16  Ʌ  ¬((12)  V  (7 Ʌ 11))
<span class="fc bfc" id="L325" title="All 10 branches covered.">            if (</span>
            ((input.getValue(col + 1, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col, row - 1) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row) &gt; 0)) 
                || (input.getValue(col + 1, row) &gt; 0))) {
<span class="fc" id="L331">            return true;</span>
        } else 
            //8  Ʌ  15  Ʌ  ¬((12 Ʌ  16)  V  (7 Ʌ 11))
<span class="pc bpc" id="L334" title="1 of 12 branches missed.">            if (</span>
            ((input.getValue(col + 1, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row - 1) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col + 1, row) &gt; 0) 
                &amp;&amp; (input.getValue(col, row - 1) &gt; 0)) || 
                ((input.getValue(col, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row) &gt; 0)))) {
<span class="fc" id="L341">            return true;</span>
        } else 
            //8  Ʌ  11  Ʌ  ¬((7)  V  (12 Ʌ 16))
<span class="fc bfc" id="L344" title="All 10 branches covered.">            if (</span>
            ((input.getValue(col + 1, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col + 1, row) &gt; 0) 
                &amp;&amp; (input.getValue(col, row - 1) &gt; 0)) 
                || (input.getValue(col, row + 1) &gt; 0))) {
<span class="fc" id="L350">            return true;</span>
        } else 
            //12  Ʌ  15  Ʌ  ¬((16)  V  (7 Ʌ 11))
<span class="fc bfc" id="L353" title="All 10 branches covered.">            if (</span>
            ((input.getValue(col + 1, row) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row - 1) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row) &gt; 0)) 
                || (input.getValue(col, row - 1) &gt; 0))) {
<span class="fc" id="L359">            return true;</span>
        } else 
            //12  Ʌ  11  Ʌ  ¬((16)  V  (7))
<span class="fc bfc" id="L362" title="All 8 branches covered.">            if (</span>
            ((input.getValue(col + 1, row) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row) &gt; 0)) &amp;&amp; 
                !((input.getValue(col, row + 1) &gt; 0) 
                || (input.getValue(col, row - 1) &gt; 0))) {
<span class="fc" id="L367">            return true;</span>
        } else 
            //17  Ʌ  15  Ʌ  ¬((16)  V  (7 Ʌ 11 Ʌ 12))
<span class="fc bfc" id="L370" title="All 12 branches covered.">            if (</span>
            ((input.getValue(col + 1, row - 1) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row - 1) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row) &gt; 0) 
                &amp;&amp; (input.getValue(col + 1, row) &gt; 0)) 
                || (input.getValue(col, row - 1) &gt; 0))) {
<span class="fc" id="L377">            return true;</span>
        } else 
            //17  Ʌ  11  Ʌ  ¬((16)  V  (7 Ʌ 12))
<span class="fc bfc" id="L380" title="All 10 branches covered.">            if (</span>
            ((input.getValue(col + 1, row - 1) &gt; 0) 
                &amp;&amp; (input.getValue(col - 1, row) &gt; 0)) &amp;&amp; 
                !(((input.getValue(col, row + 1) &gt; 0) 
                &amp;&amp; (input.getValue(col + 1, row) &gt; 0)) 
                || (input.getValue(col, row - 1) &gt; 0))) {
<span class="fc" id="L386">            return true;</span>
        }
        
<span class="fc" id="L389">        return false;</span>
    }
    
    private boolean hasAZeroInNeighbors(final GreyscaleImage input, int col, 
        int row) {
         
<span class="fc" id="L395">        int ks = 3;</span>
<span class="fc" id="L396">        int h = ks &gt;&gt; 1;</span>
        
        // search for a zero in the neighboring 8 pixels
<span class="fc bfc" id="L399" title="All 2 branches covered.">        for (int kCol = 0; kCol &lt; ks; kCol++) {</span>

<span class="fc" id="L401">            int x = kCol - h;</span>
<span class="fc" id="L402">            int imgX = col + x;</span>

<span class="fc bfc" id="L404" title="All 4 branches covered.">            if ((imgX &lt; 0) || (imgX &gt; (input.getWidth() - 1))) {</span>
<span class="fc" id="L405">                continue;</span>
            }

<span class="fc bfc" id="L408" title="All 2 branches covered.">            for (int kRow = 0; kRow &lt; ks; kRow++) {</span>

<span class="fc" id="L410">                int y = kRow - h;</span>
<span class="fc" id="L411">                int imgY = row + y;</span>

<span class="fc bfc" id="L413" title="All 4 branches covered.">                if ((imgY &lt; 0) || (imgY &gt; (input.getHeight() - 1))) {</span>
<span class="fc" id="L414">                    continue;</span>
                }

<span class="fc bfc" id="L417" title="All 2 branches covered.">                if (input.getValue(imgX, imgY) == 0) {</span>
<span class="fc" id="L418">                    return true;</span>
                }
            }
        }
        
<span class="fc" id="L423">        return false;</span>
    }

    /**
     * return true if this endpoint (col, row) is the end of a line that has 
     * a width of 1 pixel.
     * 
     * @param input
     * @param col
     * @param row
     * @return 
     */
    protected boolean isTheEndOfAOnePixelLine(final GreyscaleImage input, 
        int col, int row) {
        
        //TODO: this method could be simplified
        
        /*
          . @ .
          . C .
          . . .
        */
<span class="fc bfc" id="L445" title="All 16 branches covered.">        if ((input.getValue(col, row + 1) &gt; 0) &amp;&amp; </span>
            (input.getValue(col + 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col + 1, row) == 0) &amp;&amp; 
            (input.getValue(col + 1, row - 1) == 0) &amp;&amp; 
            (input.getValue(col, row - 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row - 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row) == 0) &amp;&amp; 
            (input.getValue(col - 1, row + 1) == 0)
        ) {
            /* further check that line thickness is 1 outside of the 8 neighbors
            
            # # #
            . @ .
            . C .
            . . .
            */
<span class="pc bpc" id="L461" title="1 of 2 branches missed.">            if ((row + 2) &gt; (input.getHeight() - 1)) {</span>
<span class="nc" id="L462">                return true;</span>
            }
            // only 1 of the '#' can be non-zero
<span class="fc" id="L465">            int count = 0;</span>
<span class="fc bfc" id="L466" title="All 2 branches covered.">            if (input.getValue(col - 1, row + 2) &gt; 0) {</span>
<span class="fc" id="L467">                count++;</span>
            }
<span class="fc bfc" id="L469" title="All 2 branches covered.">            if (input.getValue(col, row + 2) &gt; 0) {</span>
<span class="fc" id="L470">                count++;</span>
            }
<span class="fc bfc" id="L472" title="All 2 branches covered.">            if (input.getValue(col + 1, row + 2) &gt; 0) {</span>
<span class="fc" id="L473">                count++;</span>
            }
<span class="fc bfc" id="L475" title="All 2 branches covered.">            if (count &gt; 1) {</span>
<span class="fc" id="L476">                return false;</span>
            }
            
<span class="fc" id="L479">            return true;</span>
        }
        /*
          . . @
          . C .
          . . .
        */
<span class="fc bfc" id="L486" title="All 16 branches covered.">        if ((input.getValue(col + 1, row + 1) &gt; 0) &amp;&amp; </span>
            (input.getValue(col + 1, row) == 0) &amp;&amp; 
            (input.getValue(col + 1, row - 1) == 0) &amp;&amp;
            (input.getValue(col, row - 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row - 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row) == 0) &amp;&amp; 
            (input.getValue(col - 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col, row + 1) == 0)
            
        ) {
            /* further check that line thickness is 1 outside of the 8 neighbors
            
              # # #
            . . @ #
            . C . #
            . . .
            */
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">            if ((row + 2) &gt; (input.getHeight() - 1)) {</span>
                /*
                  . . @ #
                  . C . #
                  . . 
                */
<span class="nc bnc" id="L509" title="All 2 branches missed.">                if ((col + 2) &gt; (input.getWidth() - 1)) {</span>
<span class="nc" id="L510">                    return true;</span>
                }
<span class="nc" id="L512">                int count = 0;</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">                if (input.getValue(col + 2, row + 1) &gt; 0) {</span>
<span class="nc" id="L514">                    count++;</span>
                }
<span class="nc bnc" id="L516" title="All 2 branches missed.">                if (input.getValue(col + 2, row) &gt; 0) {</span>
<span class="nc" id="L517">                    count++;</span>
                }
<span class="nc bnc" id="L519" title="All 2 branches missed.">                if (count &gt; 1) {</span>
<span class="nc" id="L520">                    return false;</span>
                }
<span class="nc" id="L522">                return true;</span>
<span class="fc bfc" id="L523" title="All 2 branches covered.">            } else if ((col + 2) &gt; (input.getWidth() - 1)) {</span>
                /*     # #
                     . . @
                     . C .
                     . . .
                */
<span class="fc" id="L529">                int count = 0;</span>
<span class="fc bfc" id="L530" title="All 2 branches covered.">                if (input.getValue(col, row + 2) &gt; 0) {</span>
<span class="fc" id="L531">                    count++;</span>
                }
<span class="pc bpc" id="L533" title="1 of 2 branches missed.">                if (input.getValue(col + 1, row + 2) &gt; 0) {</span>
<span class="fc" id="L534">                    count++;</span>
                }
<span class="fc bfc" id="L536" title="All 2 branches covered.">                if (count &gt; 1) {</span>
<span class="fc" id="L537">                    return false;</span>
                }
<span class="fc" id="L539">                return true;</span>
            }
            
            /*
              # # #
            . . @ #
            . C . #
            . . .
            */
            
            // only 1 of the '#' can be non-zero
<span class="fc" id="L550">            int count = 0;</span>
<span class="fc bfc" id="L551" title="All 2 branches covered.">            if (input.getValue(col, row + 2) &gt; 0) {</span>
<span class="fc" id="L552">                count++;</span>
            }
<span class="fc bfc" id="L554" title="All 2 branches covered.">            if (input.getValue(col + 1, row + 2) &gt; 0) {</span>
<span class="fc" id="L555">                count++;</span>
            }
<span class="fc bfc" id="L557" title="All 2 branches covered.">            if (input.getValue(col + 2, row + 2) &gt; 0) {</span>
<span class="fc" id="L558">                count++;</span>
            }
<span class="fc bfc" id="L560" title="All 2 branches covered.">            if (input.getValue(col + 2, row + 1) &gt; 0) {</span>
<span class="fc" id="L561">                count++;</span>
            }
<span class="fc bfc" id="L563" title="All 2 branches covered.">            if (input.getValue(col + 2, row) &gt; 0) {</span>
<span class="fc" id="L564">                count++;</span>
            }
<span class="fc bfc" id="L566" title="All 2 branches covered.">            if (count &gt; 1) {</span>
<span class="fc" id="L567">                return false;</span>
            }
            
<span class="fc" id="L570">            return true;</span>
        }
        /*
          . . .
          . C @
          . . .
        */
<span class="fc bfc" id="L577" title="All 16 branches covered.">        if ((input.getValue(col + 1, row) &gt; 0) &amp;&amp; </span>
            (input.getValue(col + 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col, row + 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row) == 0) &amp;&amp; 
            (input.getValue(col - 1, row - 1) == 0) &amp;&amp; 
            (input.getValue(col, row - 1) == 0) &amp;&amp; 
            (input.getValue(col + 1, row - 1) == 0)
        ) {
            /*
               . . . #
               . C @ #
               . . . #
            */
<span class="pc bpc" id="L591" title="1 of 2 branches missed.">            if ((col + 2) &gt; (input.getWidth() - 1)) {</span>
<span class="nc" id="L592">                return true;</span>
            }
            
            // only 1 of the '#' can be non-zero
<span class="fc" id="L596">            int count = 0;</span>
<span class="fc bfc" id="L597" title="All 2 branches covered.">            if (input.getValue(col + 2, row + 1) &gt; 0) {</span>
<span class="fc" id="L598">                count++;</span>
            }
<span class="fc bfc" id="L600" title="All 2 branches covered.">            if (input.getValue(col + 2, row) &gt; 0) {</span>
<span class="fc" id="L601">                count++;</span>
            }
<span class="fc bfc" id="L603" title="All 2 branches covered.">            if (input.getValue(col + 2, row - 1) &gt; 0) {</span>
<span class="fc" id="L604">                count++;</span>
            }
            
<span class="fc bfc" id="L607" title="All 2 branches covered.">            if (count &gt; 1) {</span>
<span class="fc" id="L608">                return false;</span>
            }
<span class="fc" id="L610">            return true;</span>
        }
        
        /*
          . . .
          . C .
          . . @
        */
<span class="fc bfc" id="L618" title="All 16 branches covered.">        if ((input.getValue(col + 1, row - 1) &gt; 0) &amp;&amp; </span>
            (input.getValue(col + 1, row) == 0) &amp;&amp; 
            (input.getValue(col + 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col, row + 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row) == 0) &amp;&amp; 
            (input.getValue(col - 1, row - 1) == 0) &amp;&amp; 
            (input.getValue(col, row - 1) == 0)
        ) {
            /*
               . . .
               . C . #
               . . @ #
                 # # #
            */
            
<span class="pc bpc" id="L634" title="1 of 2 branches missed.">            if ((row - 2) &lt; 0) {</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">                if ((col + 2) &gt; (input.getWidth() - 1)) {</span>
<span class="nc" id="L636">                    return true;</span>
                }
                /*
                     . . .
                     . C . #
                     . . @ #
                 */
<span class="nc" id="L643">                int count = 0;</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">                if (input.getValue(col + 2, row) &gt; 0) {</span>
<span class="nc" id="L645">                    count++;</span>
                }
<span class="nc bnc" id="L647" title="All 2 branches missed.">                if (input.getValue(col + 2, row - 1) &gt; 0) {</span>
<span class="nc" id="L648">                    count++;</span>
                }

<span class="nc bnc" id="L651" title="All 2 branches missed.">                if (count &gt; 1) {</span>
<span class="nc" id="L652">                    return false;</span>
                }
<span class="nc" id="L654">                return true;</span>
<span class="pc bpc" id="L655" title="1 of 2 branches missed.">            } else if ((col + 2) &gt; (input.getWidth() - 1)) {</span>
                /*
                     . . .
                     . C .
                     . . @
                       # #
                 */
<span class="nc" id="L662">                int count = 0;</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">                if (input.getValue(col, row - 2) &gt; 0) {</span>
<span class="nc" id="L664">                    count++;</span>
                }
<span class="nc bnc" id="L666" title="All 2 branches missed.">                if (input.getValue(col + 1, row - 2) &gt; 0) {</span>
<span class="nc" id="L667">                    count++;</span>
                }

<span class="nc bnc" id="L670" title="All 2 branches missed.">                if (count &gt; 1) {</span>
<span class="nc" id="L671">                    return false;</span>
                }
<span class="nc" id="L673">                return true;</span>
            }
            /*
                  . . .
                  . C . #
                  . . @ #
                    # # #
             */
<span class="fc" id="L681">            int count = 0;</span>
<span class="fc bfc" id="L682" title="All 2 branches covered.">            if (input.getValue(col + 2, row) &gt; 0) {</span>
<span class="fc" id="L683">                count++;</span>
            }
<span class="fc bfc" id="L685" title="All 2 branches covered.">            if (input.getValue(col + 2, row - 1) &gt; 0) {</span>
<span class="fc" id="L686">                count++;</span>
            }
<span class="fc bfc" id="L688" title="All 2 branches covered.">            if (input.getValue(col + 2, row - 2) &gt; 0) {</span>
<span class="fc" id="L689">                count++;</span>
            }
<span class="fc bfc" id="L691" title="All 2 branches covered.">            if (input.getValue(col + 1, row - 2) &gt; 0) {</span>
<span class="fc" id="L692">                count++;</span>
            }
<span class="fc bfc" id="L694" title="All 2 branches covered.">            if (input.getValue(col, row - 2) &gt; 0) {</span>
<span class="fc" id="L695">                count++;</span>
            }
<span class="fc bfc" id="L697" title="All 2 branches covered.">            if (count &gt; 1) {</span>
<span class="fc" id="L698">                return false;</span>
            }
<span class="fc" id="L700">            return true;</span>
        }
        
        /*
          . . .
          . C .
          . @ .
        */
<span class="fc bfc" id="L708" title="All 16 branches covered.">        if ((input.getValue(col, row - 1) &gt; 0) &amp;&amp; </span>
            (input.getValue(col + 1, row - 1) == 0) &amp;&amp; 
            (input.getValue(col + 1, row) == 0) &amp;&amp; 
            (input.getValue(col + 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col, row + 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row) == 0) &amp;&amp; 
            (input.getValue(col - 1, row - 1) == 0)
        ) {
            /*
               . . . 
               . C . 
               . @ . 
               # # #
            */
<span class="pc bpc" id="L723" title="1 of 2 branches missed.">            if ((row - 2) &lt; 0) {</span>
<span class="nc" id="L724">                return true;</span>
            }
            
            // only 1 of the '#' can be non-zero
<span class="fc" id="L728">            int count = 0;</span>
<span class="fc bfc" id="L729" title="All 2 branches covered.">            if (input.getValue(col - 1, row - 2) &gt; 0) {</span>
<span class="fc" id="L730">                count++;</span>
            }
<span class="fc bfc" id="L732" title="All 2 branches covered.">            if (input.getValue(col, row - 2) &gt; 0) {</span>
<span class="fc" id="L733">                count++;</span>
            }
<span class="fc bfc" id="L735" title="All 2 branches covered.">            if (input.getValue(col + 1, row - 2) &gt; 0) {</span>
<span class="fc" id="L736">                count++;</span>
            }
            
<span class="fc bfc" id="L739" title="All 2 branches covered.">            if (count &gt; 1) {</span>
<span class="fc" id="L740">                return false;</span>
            }
<span class="fc" id="L742">            return true;</span>
        }
        
        /*
          . . .
          . C .
          @ . .
        */
<span class="fc bfc" id="L750" title="All 16 branches covered.">        if ((input.getValue(col - 1, row - 1) &gt; 0) &amp;&amp; </span>
            (input.getValue(col, row - 1) == 0) &amp;&amp; 
            (input.getValue(col + 1, row - 1) == 0) &amp;&amp; 
            (input.getValue(col + 1, row) == 0) &amp;&amp; 
            (input.getValue(col + 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col, row + 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row) == 0)
        ) {
            /*
                 . . .
               # . C .
               # @ . .
               # # # 
            */
<span class="pc bpc" id="L765" title="1 of 2 branches missed.">            if ((col - 2) &lt; 0) {</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">                if ((row - 2) &lt; 0) {</span>
<span class="nc" id="L767">                    return true;</span>
                }
                /*
                      . . .
                      . C .
                      @ . .
                      # # 
                */
                // only 1 of the '#' can be non-zero
<span class="nc" id="L776">                int count = 0;</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">                if (input.getValue(col - 1, row - 2) &gt; 0) {</span>
<span class="nc" id="L778">                    count++;</span>
                }
<span class="nc bnc" id="L780" title="All 2 branches missed.">                if (input.getValue(col, row - 2) &gt; 0) {</span>
<span class="nc" id="L781">                    count++;</span>
                }
<span class="nc bnc" id="L783" title="All 2 branches missed.">                if (count &gt; 1) {</span>
<span class="nc" id="L784">                    return false;</span>
                }
<span class="nc" id="L786">                return true;</span>
<span class="pc bpc" id="L787" title="1 of 2 branches missed.">            } else if ((row - 2) &lt; 0) {</span>
                /*
                       . . .
                     # . C .
                     # @ . .
                 */
<span class="nc" id="L793">                int count = 0;</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">                if (input.getValue(col - 2, row) &gt; 0) {</span>
<span class="nc" id="L795">                    count++;</span>
                }
<span class="nc bnc" id="L797" title="All 2 branches missed.">                if (input.getValue(col - 2, row - 1) &gt; 0) {</span>
<span class="nc" id="L798">                    count++;</span>
                }
<span class="nc bnc" id="L800" title="All 2 branches missed.">                if (count &gt; 1) {</span>
<span class="nc" id="L801">                    return false;</span>
                }
<span class="nc" id="L803">                return true;</span>
            }
            /*
                 . . .
               # . C .
               # @ . .
               # # # 
            */
<span class="fc" id="L811">            int count = 0;</span>
<span class="fc bfc" id="L812" title="All 2 branches covered.">            if (input.getValue(col - 2, row) &gt; 0) {</span>
<span class="fc" id="L813">                count++;</span>
            }
<span class="fc bfc" id="L815" title="All 2 branches covered.">            if (input.getValue(col - 2, row - 1) &gt; 0) {</span>
<span class="fc" id="L816">                count++;</span>
            }
<span class="fc bfc" id="L818" title="All 2 branches covered.">            if (input.getValue(col - 2, row - 2) &gt; 0) {</span>
<span class="fc" id="L819">                count++;</span>
            }
<span class="fc bfc" id="L821" title="All 2 branches covered.">            if (input.getValue(col - 1, row - 2) &gt; 0) {</span>
<span class="fc" id="L822">                count++;</span>
            }
<span class="fc bfc" id="L824" title="All 2 branches covered.">            if (input.getValue(col, row - 2) &gt; 0) {</span>
<span class="fc" id="L825">                count++;</span>
            }

<span class="fc bfc" id="L828" title="All 2 branches covered.">            if (count &gt; 1) {</span>
<span class="fc" id="L829">                return false;</span>
            }
<span class="fc" id="L831">            return true;</span>
        }
        
        /*
          . . .
          @ C .
          . . .
        */
<span class="fc bfc" id="L839" title="All 16 branches covered.">        if ((input.getValue(col - 1, row) &gt; 0) &amp;&amp; </span>
            (input.getValue(col - 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col, row + 1) == 0) &amp;&amp; 
            (input.getValue(col + 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col + 1, row) == 0) &amp;&amp; 
            (input.getValue(col + 1, row - 1) == 0) &amp;&amp; 
            (input.getValue(col, row - 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row - 1) == 0)
        ) {
            /*
                # . . .
                # @ C .
                # . . .
            */
<span class="pc bpc" id="L853" title="1 of 2 branches missed.">            if ((col - 2) &lt; 0) {</span>
<span class="nc" id="L854">                return true;</span>
            }
            
            // only 1 of the '#' can be non-zero
<span class="fc" id="L858">            int count = 0;</span>
<span class="fc bfc" id="L859" title="All 2 branches covered.">            if (input.getValue(col - 2, row - 1) &gt; 0) {</span>
<span class="fc" id="L860">                count++;</span>
            }
<span class="fc bfc" id="L862" title="All 2 branches covered.">            if (input.getValue(col - 2, row) &gt; 0) {</span>
<span class="fc" id="L863">                count++;</span>
            }
<span class="fc bfc" id="L865" title="All 2 branches covered.">            if (input.getValue(col - 2, row + 1) &gt; 0) {</span>
<span class="fc" id="L866">                count++;</span>
            }
            
<span class="fc bfc" id="L869" title="All 2 branches covered.">            if (count &gt; 1) {</span>
<span class="fc" id="L870">                return false;</span>
            }
<span class="fc" id="L872">            return true;</span>
        }
        
        /*
          @ . .
          . C .
          . . .
        */
<span class="fc bfc" id="L880" title="All 16 branches covered.">        if ((input.getValue(col - 1, row + 1) &gt; 0) &amp;&amp; </span>
            (input.getValue(col, row + 1) == 0) &amp;&amp; 
            (input.getValue(col + 1, row + 1) == 0) &amp;&amp; 
            (input.getValue(col + 1, row) == 0) &amp;&amp; 
            (input.getValue(col + 1, row - 1) == 0) &amp;&amp; 
            (input.getValue(col, row - 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row - 1) == 0) &amp;&amp; 
            (input.getValue(col - 1, row) == 0)
        ) {
<span class="pc bpc" id="L889" title="1 of 2 branches missed.">            if ((col - 2) &lt; 0) {</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">                if ((row + 2) &gt; (input.getHeight() - 1)) {</span>
<span class="nc" id="L891">                    return true;</span>
                }
                /*
                     # #
                     @ . .
                     . C .
                     . . .
                */
                // only 1 of the '#' can be non-zero
<span class="nc" id="L900">                int count = 0;</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">                if (input.getValue(col - 1, row + 2) &gt; 0) {</span>
<span class="nc" id="L902">                    count++;</span>
                }
<span class="nc bnc" id="L904" title="All 2 branches missed.">                if (input.getValue(col, row + 2) &gt; 0) {</span>
<span class="nc" id="L905">                    count++;</span>
                }

<span class="nc bnc" id="L908" title="All 2 branches missed.">                if (count &gt; 1) {</span>
<span class="nc" id="L909">                    return false;</span>
                }
<span class="nc" id="L911">                return true;</span>
<span class="pc bpc" id="L912" title="1 of 2 branches missed.">            } else if ((row + 2) &gt; (input.getHeight() - 1)) {</span>
                /*
                    # @ . .
                    # . C .
                    . . .
                 */
<span class="nc" id="L918">                int count = 0;</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">                if (input.getValue(col - 2, row) &gt; 0) {</span>
<span class="nc" id="L920">                    count++;</span>
                }
<span class="nc bnc" id="L922" title="All 2 branches missed.">                if (input.getValue(col - 2, row + 1) &gt; 0) {</span>
<span class="nc" id="L923">                    count++;</span>
                }

<span class="nc bnc" id="L926" title="All 2 branches missed.">                if (count &gt; 1) {</span>
<span class="nc" id="L927">                    return false;</span>
                }
<span class="nc" id="L929">                return true;</span>
            }
            /*
               # # #
               # @ . .
               # . C .
                 . . .
            */
<span class="fc" id="L937">            int count = 0;</span>
<span class="fc bfc" id="L938" title="All 2 branches covered.">            if (input.getValue(col - 2, row) &gt; 0) {</span>
<span class="fc" id="L939">                count++;</span>
            }
<span class="fc bfc" id="L941" title="All 2 branches covered.">            if (input.getValue(col - 2, row + 1) &gt; 0) {</span>
<span class="fc" id="L942">                count++;</span>
            }
<span class="fc bfc" id="L944" title="All 2 branches covered.">            if (input.getValue(col - 2, row + 2) &gt; 0) {</span>
<span class="fc" id="L945">                count++;</span>
            }
<span class="fc bfc" id="L947" title="All 2 branches covered.">            if (input.getValue(col - 1, row + 2) &gt; 0) {</span>
<span class="fc" id="L948">                count++;</span>
            }
<span class="fc bfc" id="L950" title="All 2 branches covered.">            if (input.getValue(col, row + 2) &gt; 0) {</span>
<span class="fc" id="L951">                count++;</span>
            }

<span class="fc bfc" id="L954" title="All 2 branches covered.">            if (count &gt; 1) {</span>
<span class="fc" id="L955">                return false;</span>
            }
<span class="fc" id="L957">            return true;</span>
        }
        
<span class="fc" id="L960">        return false;</span>
    }

    /**
     * return true if pixel at (i, j) is nullable, that is does not disconnect
     * other currently connected points
     * @param input
     * @param output
     * @param i
     * @param j
     * @return 
     */
    private boolean process(final GreyscaleImage input, final GreyscaleImage 
        output, int i, int j) {
        
<span class="fc bfc" id="L975" title="All 2 branches covered.">        if (output.getValue(i, j) == 0) {</span>
<span class="fc" id="L976">            return false;</span>
        }

<span class="fc bfc" id="L979" title="All 4 branches covered.">        if (!isASmallerSearchRegion(output, i, j)</span>
            &amp;&amp; hasImmediateFourNeighbors(output, i, j)) {

<span class="fc" id="L982">            return false;</span>
        }

        // choosing input here helps to thin a line from one direction
        // at a time rather than continue thinning from the same
        // direction
<span class="fc bfc" id="L988" title="All 2 branches covered.">        if (hasAZeroInNeighbors(input, i, j)) {</span>

            //if (!doesDisconnectOrIsEndPoint(output, i, j)) {
<span class="fc bfc" id="L991" title="All 2 branches covered.">            if (canBeNulled(output, i, j)) {</span>
                
<span class="fc" id="L993">                output.setValue(i, j, 0);</span>

<span class="fc" id="L995">                return true;</span>
            }
        }
        
<span class="fc" id="L999">        return false;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>